set -e

EXE=$(readlink -f $0)
MY_INODE=$(stat -c '%i' $EXE)
echo ${EXE}

wait_restart( ) 
{
	c=$1
	if test -f *${c}*pid ; then
		pid=$(cat $(*${c}*.pid))
		ps -p ${pid} && return
	fi 
	if ! inotifywait -e close -t 120 *${c}*status; then
		echo $(date) ${c} restarted >> restarted.log
		bash allrestart ${c}
	fi
}

while true; do 
for f in *.balance; do
	c=$(echo $f | awk -F'_' '{print $4}')
	wait_restart $c &
done

nohup sleep 30 &

wait

INODE_FREE=$(stat -f . -c '%d')
if [ $INODE_FREE -lt 100000 ]; then
	bash allbackup
fi

NEW_INODE=$(stat -c '%i' $EXE)

if [ ${MY_INODE} -ne  ${NEW_INODE} ]; then
	wall $(date)
	nohup bash $EXE &
	exit
fi

done
