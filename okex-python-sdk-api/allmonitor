set -e

EXE=$(readlink -f $0)
MY_INODE=$(stat -c '%i' $EXE)
echo ${EXE}

wait_restart( ) 
{
	c=$1
	if [[ -f *${c}*pid ]] ; then
		pid=$(cat *${c}*.pid)
		ps -p ${pid} && return
	fi 
	if ! inotifywait -e close -t 120 *${c}*status; then
		echo $(date) ${c} restarted >> restarted.log
		bash allrestart ${c}
	fi
}

while true; do 
COINS=''
CONTRACTS=''
PERIODS=''
for f in *.balance; do
	c=$(echo $f | awk -F'_' '{print $4}')
	COINS="${COINS} $c"
	CONTRACTS="${CONTRACTS} $(echo $f | awk -F'_' '{print $6}')"
	PERIODS="${PERIODS} $(echo $f | awk -F'_' '{print $7}' | awk -F'.' '{print $1}')"
	wait_restart $c &
done

echo $COINS | tr ' ' '\n' | sort | uniq | tr '\n' ' ' > .coins
echo $CONTRACTS | tr ' ' '\n' | sort | uniq | tr '\n' ' ' > .contracts
echo $PERIODS | tr ' ' '\n' | sort | uniq | tr '\n' ' ' > .periods

nohup sleep 30 &

wait

INODE_FREE=$(stat -f . -c '%d')
if [ $INODE_FREE -lt 100000 ]; then
	bash allbackup
fi

NEW_INODE=$(stat -c '%i' $EXE)

if [ ${MY_INODE} -ne  ${NEW_INODE} ]; then
	wall $(date)
	nohup bash $EXE &
	exit
fi

done
